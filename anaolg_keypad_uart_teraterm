#include <stdint.h>
#include <stdlib.h>
#include "inc/tm4c123gh6pm.h"

void UART0_Init(void);
void UART_TxChar(char data);
void UART_TxString(char *str);
unsigned char key_scan(unsigned int volatile rec_val);
void delay_ms(uint32_t ms);

int main(void)
{
    uint32_t ui32ADC0Value;
    unsigned char current_key = '\0';
    unsigned char last_key = '\0';
    
    SYSCTL_RCGCGPIO_R |= (1 << 3);
    SYSCTL_RCGCADC_R |= 1;
    
    GPIO_PORTD_AFSEL_R |= 0x04;
    GPIO_PORTD_DEN_R &= ~0x04;
    GPIO_PORTD_AMSEL_R |= 0x04;
    
    ADC0_ACTSS_R &= ~1;
    ADC0_EMUX_R &= ~0x000F;
    ADC0_SSMUX0_R |= 0x05;
    ADC0_SSCTL0_R |= 0x06;
    ADC0_ACTSS_R |= 0x01;
    
    UART0_Init();
    UART_TxString("Analog Keypad Ready\n\r");
    UART_TxString("Press a key...\n\r");
    
    while(1)
    {
        ADC0_PSSI_R |= 1;
        while((ADC0_RIS_R & 1) == 0);
        ui32ADC0Value = ADC0_SSFIFO0_R;
        ADC0_ISC_R = 1;
        
        current_key = key_scan(ui32ADC0Value / 10);
        
        if (current_key != 'G' && current_key != last_key) {
            UART_TxString("Key Pressed: ");
            UART_TxChar(current_key);
            UART_TxString("\n\r");
            
            last_key = current_key;
        }
        
        delay_ms(100);
    }
}

unsigned char key_scan(unsigned int volatile rec_val)
{
    if (rec_val >= 373 && rec_val <= 374) return '0';
    else if (rec_val >= 376 && rec_val <= 377) return '1';
    else if (rec_val >= 380 && rec_val <= 382) return '2';
    else if (rec_val >= 381 && rec_val <= 382) return '3';
    else if (rec_val >= 357 && rec_val <= 358) return '4';
    else if (rec_val >= 362 && rec_val <= 363) return '5';
    else if (rec_val >= 367 && rec_val <= 369) return '6';
    else if (rec_val >= 371 && rec_val <= 372) return '7';
    else if (rec_val >= 317 && rec_val <= 318) return '8';
    else if (rec_val >= 333 && rec_val <= 334) return '9';
    else if (rec_val >= 345 && rec_val <= 347) return 'A';
    else if (rec_val >= 353 && rec_val <= 354) return 'B';
    else if (rec_val == 0) return 'C';
    else if (rec_val >= 203 && rec_val <= 204) return 'D';
    else if (rec_val >= 272 && rec_val <= 274) return 'E';
    else if (rec_val >= 306 && rec_val <= 308) return 'F';
    else
        return 'G';
}

void UART0_Init(void)
{
    SYSCTL_RCGCUART_R |= (1 << 0);
    SYSCTL_RCGCGPIO_R |= (1 << 0);
    
    GPIO_PORTA_AFSEL_R |= 0x03;
    GPIO_PORTA_PCTL_R = (GPIO_PORTA_PCTL_R & 0xFFFFFF00) | 0x00000011;
    GPIO_PORTA_DEN_R |= 0x03;
    
    UART0_CTL_R &= ~0x01;
    UART0_IBRD_R = 104;
    UART0_FBRD_R = 11;
    UART0_LCRH_R = 0x70;
    UART0_CTL_R |= 0x301;
}

void UART_TxChar(char data) {
    while ((UART0_FR_R & 0x20) != 0);
    UART0_DR_R = data;
}

void UART_TxString(char *str) {
    while (*str) {
        UART_TxChar(*str++);
    }
}

void delay_ms(uint32_t ms) {
    uint32_t i, j;
    for (i = 0; i < ms; i++) {
        for (j = 0; j < 3180; j++) {}
    }
}
